function make_message(e){if("MESSAGE"==e.type||"TIPS"==e.type||is_album_message_type(e.type)){e.text=e.text.replace(RegExp("<([1-9]|[1-2][0-9]|3[0-5])>","g"),"<img border=0 width=30px src='https://github.com/Dayset/Improved-chat-message-generation/raw/main/smileys/$1.gif'>"),e.text=e.text.replace(RegExp("<(\\d+)>","g"),"<img border=0 src=/img/smiles/smile$1.gif>"),e.text=e.text.replace(RegExp("йух","g"),"хуй");var t="color:#"+e.color+"; font-weight:bold;",i="color:#"+e.color+";",s=e.time.substr(11,8),a="",r=!1,l="";if(0==e.is_private){a="<span class='"+("f"==e.user_sex?"time_girl":"time_boy")+"'>("+s+")</span>",0<e.user_id&&(a+=make_dropdown_menu_to_user(e,!1),a+="<a style='"+t+";text-decoration:underline;' href='javascript:writeName(\""+e.user_nick.replace(/&quot;/g,'\\"')+"\")'>"+e.user_nick+"</a>"),a+="<span style='"+i+"'>: ";let n=e.text.split(" ");n.forEach(e=>{if(r)l+=e+" ",a+=e+" ";else{let t=null;if(e.includes("youtube.com/watch?v=")){let i=new URL(e);t=i.searchParams.get("v")}else e.includes("youtu.be/")&&(t=e.split("youtu.be/")[1]);t||/^[a-zA-Z0-9_-]{11}$/.test(e)?(a+=`<iframe src="https://www.youtube.com/embed/${t=t||e}"width="512"height="64"frameborder="0"style="display:inline-block; vertical-align:middle; margin-left:5px;"allow="autoplay; encrypted-media"allowfullscreen></iframe>`,r=!0):(l+=e+" ",a+=e+" ")}}),a+="</span>",speakMessage(l.trim(),!1)}else{if(a="<span class='"+("f"==e.user_sex?"time_girl":"time_boy")+"'>("+s+")</span>",0<e.user_id){a+=make_dropdown_menu_to_user(e,!0),s=escapeQuot(escape_user_nick(e.user_nick)),a+="<a style='"+t+";text-decoration:underline;' href='javascript:header_send_private("+e.user_id+', "'+s+"\")'>"+e.user_nick+"</a>";let c=e.text.split(" ");c.forEach(e=>{if(r)l+=e+" ",a+=e+" ";else{let t=null;if(e.includes("youtube.com/watch?v=")){let i=new URL(e);t=i.searchParams.get("v")}else e.includes("youtu.be/")&&(t=e.split("youtu.be/")[1]);t||/^[a-zA-Z0-9_-]{11}$/.test(e)?(a+=`<iframe src="https://www.youtube.com/embed/${t=t||e}"width="512"height="64"frameborder="0"style="display:inline-block; vertical-align:middle; margin-left:5px;"allow="autoplay; encrypted-media"allowfullscreen></iframe>`,r=!0):(l+=e+" ",a+=e+" ")}})}speakMessage(l.trim(),!0,e.user_nick,e.to_user_nick)}}return"READY"==e.type&&(a=e.text),a}function speakMessage(e,t,i,s){let a=e.replace(/<a[^>]*>(.*?)<\/a>/gi,"$1").replace(/<img[^>]*>/gi,"").replace(/<iframe[^>]*>[\s\S]*?<\/iframe>/gi,"").replace(/<\/?[^>]+(>|$)/g,""),r=/[а-яёА-ЯЁ]/.test(a);if(t&&i&&s&&(a=">"+i+" to "+s+" "+a),a.trim().endsWith("?")&&(a+=r?" Вопрос":" Question mark"),"speechSynthesis"in window){let l=new SpeechSynthesisUtterance(a);l.lang=r?"ru-RU":"en-US",l.rate=1,l.pitch=1,speechSynthesis.speak(l)}else console.warn("Text-to-Speech is not supported in this browser.")}
