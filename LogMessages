// Function to send a message from the console
function sendConsoleMessage(text) {
  // Create a message object with required properties
  var consoleMessage = {
    type: "MESSAGE",
    text: text,
    color: getCurrentUserColor(), // You'll need to have this function or hardcode a color
    time: new Date().toISOString(),
    user_id: getCurrentUserId(), // You'll need to have this function or hardcode an ID
    user_nick: getCurrentUserNick(), // You'll need to have this function or hardcode a nickname
    user_sex: getCurrentUserSex(), // You'll need to have this function or hardcode a value ('m' or 'f')
    is_private: 0 // Default to public message
  };
  
  // Process the message through the regular channel
  var html = make_message(consoleMessage);
  
  // Add the message to the chat display
  addMessageToChat(html); // This is a placeholder - you'll need a function that adds HTML to your chat
  
  // Send the message to the server
  sendMessageToServer(consoleMessage); // This is a placeholder - you'll need your actual send function
  
  return "Message sent: " + text;
}

// Add the function to the window object so it can be called from console
window.sendConsoleMessage = sendConsoleMessage;

// Log instructions to the console
console.log('To send a message from console, type: sendConsoleMessage("your message here")');

function make_message(message) {
  // Only log name and message text for visible messages in a simple format
  if (message.type == "MESSAGE" || message.type == "TIPS" || is_album_message_type(message.type)) {
    var cleanMessage = message.text;
    // Remove any HTML tags from the message text to get plain text
    if (cleanMessage) {
      cleanMessage = cleanMessage.replace(/<[^>]*>?/gm, '');
    }
    
    if (message.is_private == 0) {
      // Public message format: [name: message]
      console.log('[' + message.user_nick + ': ' + cleanMessage + ']');
    } else {
      // Private message format: [name → recipient: message]
      console.log('[' + message.user_nick + ' → ' + message.to_user_nick + ': ' + cleanMessage + ']');
    }
  }
  
  var html;
  if (message.type == "MESSAGE" || message.type == "TIPS" || is_album_message_type(message.type)) {
    
    if (!is_album_message_type(message.type)) {
      message.text = message.text.replace(new RegExp("<([1-9]|[1-2][0-9]|3[0-5])>",'g'), "<img border=0 width=30px src='https://github.com/Dayset/Improved-chat-message-generation/raw/main/smileys/$1.gif'>");} 
    if (!is_album_message_type(message.type)) {
      message.text = message.text.replace(new RegExp("<(\\d+)>",'g'), "<img border=0 src=\/img\/smiles\/smile$1.gif>");
    }  
    
    var nick_style = "color:#" + message.color + "; font-weight:bold;";
    var message_style = "color:#" + message.color + ";";
    var message_time = message.time.substr(11, 8);

    if (message.is_private == 0) {

        html = "<span class='" + (message.user_sex == 'f' ? "time_girl" : "time_boy") + "'>(" + message_time  + ")</span>";
    if (message.user_id > 0) {
        html += make_dropdown_menu_to_user(message, false);
        html += "<a style='" + nick_style + ";text-decoration:underline;' href='javascript:writeName(\"" + message.user_nick.replace(/&quot;/g,'\\\"') + "\")'>" + message.user_nick + "</a>";
      }
        html += "<span style='" + message_style + "'>: " + make_message_text(message) + "</span>";

    } else {

        var message_month = message.time.substr(5, 2);
        var message_day   = message.time.substr(8, 2);
        html = "<span class='" + (message.user_sex == 'f' ? "time_girl" : "time_boy") + "'>(" + message_day + '.' + message_month  + ', ' + message_time + ")</span>";
    if (message.user_id > 0) {
        html += make_dropdown_menu_to_user(message, true);
        var user_nick_escape = escapeQuot(escape_user_nick(message.user_nick));
        html += "<a style='" + nick_style + ";text-decoration:underline;' href='javascript:header_send_private(" + message.user_id + ", \"" + user_nick_escape + "\")'>" + message.user_nick + "</a>";
        
        function beep() {
        var snd = new  Audio("http://shorturl.at/dwPSY");  
        snd.play();
        }
        beep();
    }
        html += "<span style='" + nick_style + "'>&rarr;" + message.to_user_nick + "</span>";
        html += "<span style='" + message_style + "'>: " + make_message_text(message) + "</span>";
    }
  }
  if (message.type == "READY") {
    html = message.text;
  }

  // No longer logging the HTML output
  
  return html;
}
